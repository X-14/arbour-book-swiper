<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Liked Books â€¢ Arbour</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arbour.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arbour.css') }}">
</head>

<body>

    <header class="brand">
        <div class="brand__inner">
            <h1>My Liked Books</h1>
            <div class="nav-bar">
                <a href="/home">Dashboard</a>
                <a href="/recommendation">Swipe</a>
                <a href="/friends">Friends</a>
                <a href="/liked" class="active">Liked Books</a>
                <a href="/preferences">Preferences</a>
                <a href="/search">Search</a>
                <a href="#" id="logoutBtn" style="color: #ff8a80;">Logout</a>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.5rem;">Your Library</h2>
                <div class="filter-controls">
                    <label for="sortFilter" style="margin-right: 10px; font-weight: 500;">Sort by:</label>
                    <select id="sortFilter"
                        style="padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-family: inherit;">
                        <option value="recent" selected>Most Recent</option>
                        <option value="match">Highest Match</option>
                        <option value="alpha">A-Z</option>
                    </select>
                </div>
            </div>
            <div id="loading" style="text-align:center; margin-top:50px;">Loading your library...</div>
            <div id="bookGrid" class="book-grid"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTUuPffjD2WeQC7MDlFKBCOcRAmREjWJs",
            authDomain: "booktinder-fb868.firebaseapp.com",
            projectId: "booktinder-fb868",
            storageBucket: "booktinder-fb868.firebasestorage.app",
            messagingSenderId: "660028415634",
            appId: "1:660028415634:web:c078752bb53502afcc904b",
            measurementId: "G-1WB2RYS3XB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let cachedBooks = []; // Store books to allow client-side sorting

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadLikedBooks(user.uid);
                document.querySelector('a[href="/recommendation"]').href = `/recommendation?user_id=${user.uid}`;
            } else {
                window.location.href = "/";
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => window.location.href = "/");
        });

        // Sorting Event Listener
        document.getElementById("sortFilter").addEventListener("change", (e) => {
            sortAndRenderBooks(e.target.value);
        });

        async function loadLikedBooks(userId) {
            try {
                const res = await fetch(`/api/liked_books?user_id=${userId}`);
                cachedBooks = await res.json(); // Store for sorting

                document.getElementById("loading").style.display = "none";

                // Default sort: Most Recent (which is the reversed order they come in typically, 
                // or we assume backend sends them in some order. Actually, backend sends them by ID usually.
                // We'll trust the default is "Recent" if the backend sends appended list, 
                // but actually the backend loop order isn't guaranteed to be time-based unless swiped timestamp is used.
                // For now, we'll default to "Highest Match" as it is the most impressive view.

                // Default sort: Most Recent
                sortAndRenderBooks("recent");

            } catch (err) {
                console.error(err);
                document.getElementById("loading").textContent = "Error loading books.";
            }
        }

        function sortAndRenderBooks(criteria) {
            const grid = document.getElementById("bookGrid");

            if (cachedBooks.length === 0) {
                grid.innerHTML = "<p style='text-align:center; width:100%;'>You haven't liked any books yet.</p>";
                return;
            }

            let sortedBooks = [...cachedBooks];

            if (criteria === "match") {
                // Sort by Score (Descending) - Parse "85.5% Match"
                sortedBooks.sort((a, b) => {
                    const scoreA = parseFloat(a.score) || 0;
                    const scoreB = parseFloat(b.score) || 0;
                    return scoreB - scoreA;
                });
            } else if (criteria === "alpha") {
                // Sort by Title (A-Z)
                sortedBooks.sort((a, b) => a.title.localeCompare(b.title));
            } else if (criteria === "recent") {
                // Backend now returns sorted by timestamp descending (Newest First).
                // So we do NOT need to reverse it. It is already correct.
                // sortedBooks = sortedBooks; (no-op)
            }

            grid.innerHTML = sortedBooks.map(book => `
                <div class="book-item">
                    <img src="${book.image_url}" alt="${book.title}">
                    <h3>${book.title}</h3>
                    <p>${book.author}</p>
                    <p style="color: #4CAF50; font-weight: bold; font-size: 0.9rem; margin-top: 5px;">${book.score}</p>
                    <button onclick="window.handleUnlike('${book.book_id}')" class="btn" style="background-color: #ef5350; margin-top: 10px; font-size: 0.8rem; padding: 5px 10px; width: auto;">Unlike</button>
                </div>
            `).join("");
        }

        window.handleUnlike = async (bookId) => {
            const user = auth.currentUser;
            if (!user) return;

            if (!confirm("Are you sure you want to unlike this book?")) return;

            try {
                const res = await fetch('/api/unlike', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.uid,
                        book_id: bookId
                    })
                });

                if (res.ok) {
                    // Remove from cache and re-render
                    cachedBooks = cachedBooks.filter(b => b.book_id !== bookId);
                    sortAndRenderBooks(document.getElementById("sortFilter").value);
                } else {
                    alert("Failed to unlike book.");
                }
            } catch (e) {
                console.error(e);
                alert("Error unliking book.");
            }
        };
    </script>
</body>

</html>